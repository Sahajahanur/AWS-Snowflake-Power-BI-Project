CREATE OR REPLACE STORAGE INTEGRATION PBI_Integration
 TYPE = EXTERNAL_STAGE
 STORAGE_PROVIDER = 'S3'
 ENABLED = TRUE
 STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::048832330477:role/powerbi.role'
 STORAGE_ALLOWED_LOCATIONS = ('s3://powerbi.project.srl/')
 COMMENT = 'This an optional comment'


 // description Integration Object
 
DESC integration PBI_Integration;

CREATE DATABASE PowerBI;

CREATE schema PBI_Data



create table PBI_Dataset (
Year int,	Location string,	Area	int,
Rainfall	float, Temperature	float, Soil_type string,
Irrigation	string, yeilds	int,Humidity	float,
Crops	string,price	int,Season string

);

SELECT * FROM PBI_DATASET;

CREATE STAGE POWERBI.PBI_DATA.pbi_stage
url = 's3://powerbi.project.srl'
storage_integration = PBI_Integration

copy into PBI_Dataset
from @pbi_stage
file_format = (type=csv field_delimiter=',' skip_header=1)
on_error = 'continue'


SELECT YEAR, COUNT(*) Count FROM PBI_DATASET 

GROUP BY YEAR

order by year;

create table agriculture as 
select * from pbi_dataset

select * from agriculture;

update agriculture 
set rainfall = 1.1*rainfall

update agriculture
set area=0.9*area;

// YEAR GROUP 

// YEAR 2004 & 2009 - Y1
// YEAR 2010 & 2015 - Y2
// YEAR 2016 & 2019 - Y3


ALTER TABLE AGRICULTURE
add Year_Group string;

// 1st update
UPDATE AGRICULTURE 
SET YEAR_GROUP = 'Y1'
WHERE YEAR>=2004 AND YEAR<=2009

//2nd update
UPDATE AGRICULTURE 
SET YEAR_GROUP = 'Y2'
WHERE YEAR>=2010 AND YEAR<=2015

// 3rd update 
UPDATE AGRICULTURE 
SET YEAR_GROUP = 'Y3'
WHERE YEAR>=2016 AND YEAR<=2019


// Rainfull Groups

// Min 255 Max 4103

// rainfall 255 & 1200 - Low
// rainfall 1200 & 2800 - Medium
// Rainfall 2800 & 4103 - High

alter table agriculture
add rainfall_groups string;

select * from agriculture;

// 1st Update

UPDATE agriculture
set rainfall_groups = 'Low'
where rainfall>=255 and rainfall<1200

// 2nd Update

UPDATE agriculture
set rainfall_groups = 'Medium'
where rainfall>=1200 and rainfall<2800

// 3rd Update

UPDATE agriculture
set rainfall_groups = 'High'
where rainfall>=2800